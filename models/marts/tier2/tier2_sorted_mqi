SELECT 
        am.email
      , am.leadid
      , am.domainType
      , am.mqi_date
      , am.mql_date
      , am.mql
      , am.sal
      , am.salDate
      , am.sql
      , am.sqlDate
      , am.sqo
      , am.sqoDate
      , am.won
      , am.opportunityClosedWonDate
      , am.campaignSourcedBy
      , am.parentcampaignid
      , am.parentCampaign
      , am.parentctatype
      , am.parentchannel
      , am.parentCTAsubtype
      , am.childCampaign
      , am.childCTAtype
      , am.childChannel
      , am.childCTAsubtype
      , am.employeeSegment
      , am.response
      , case when am.parentCTAtype is null then 'Blank' when (parentCTAtype = 'Content Asset' or parentCTAtype =  'Video') then
          'Content/Video' when (am.parentCTAtype='Tradeshow' or am.parentCTAtype='Webinar') then 'Event/Webinar' 
           when (am.parentCTAtype='Organic Lead Score' or am.parentCTAtype='Other') then 'Other' else am.parentCTAtype end as parentCTAtype

      , case when am.childCTAtype is null then 'Blank' when (childCTAtype = 'Content Asset' or childCTAtype =  'Video') then
          'Content/Video' when (am.childCTAtype='Tradeshow' or am.childCTAtype='Webinar') then 'Event/Webinar' when
          (am.childCTAtype='Organic Lead Score' or am.childCTAtype='Other') then 'Other' else am.childCTAtype end as childCTAtype

      , case when am.parentCTAsubtype = 'User Signup' then row_number() over(partition by am.email order by am.mqi_date) end as user_rn
      , row_number() over(partition by am.email order by am.mqi_date) as rn
      , case when a.employee_segment__c is null then 'UNKNOWN' else a.employee_segment__c end as employee_segment
      , case when dt.type is null then 'Other' else dt.type end as lead_type
      , case when a.accountType = 'Prospect' then a.accountType when a.accountType = 'Customer' then a.accountType when a.accountType = 'Sub-Account' then a.accountType else 'Other' end as type 
      , case when am.persona like '%Decision Maker' then 'Decision Maker' when (am.persona like '%Influencer' or am.persona like '%General') then 'Individual Contributor' else 'Other' end as persona

FROM {{ ref('tier2_all_mqi') }} as am
LEFT JOIN {{ ref('tier2_salesforce_account') }} as a
    ON am.leadid = a.accountId
left join {{ ref('stg_salesforce_account') }} as dt
         on dt.emailDomain = split_part(am.email, '@', 2) 


